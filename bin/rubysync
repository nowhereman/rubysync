#!/opt/local/bin/ruby
#
#  Copyright (c) 2007 Ritchie Young. All rights reserved.
#
# This file is part of RubySync.
# 
# RubySync is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.
# 
# RubySync is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied
# warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License along with RubySync; if not, write to the
# Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA

lib_path = File.dirname(__FILE__) + '/../lib'
$:.unshift lib_path unless $:.include?(lib_path) || $:.include?(File.expand_path(lib_path))
require "ruby_sync"
require "simpleconsole"


class Controller < SimpleConsole::Controller

  include RubySync::Utilities
  
  params :string => {:p => :pipe,
                     :t => :type,
                     :V => :vault,
                     :C => :client},
         :int =>{:v => :verbose}

  def default
  end
  
  def example
  end
  
  # Run specified pipeline once then exit
  def once
    log_levels = [Logger::WARN, Logger::INFO, Logger::DEBUG]
    verbosity = [(params[:verbose]||0), log_levels.size-1].min
    log.level = log_levels[verbosity]
    
    pipeline_name = params[:id]
    pipeline = pipeline_called pipeline_name
    if pipeline
      pipeline.run_once
    else
      log.error "Couldn't find a pipeline called '#{pipeline_name}'"
    end
  end

  # Create a Rubysync project directory
  def create
    config_path = params[:id]
    ensure_dir_exists config_path
    ensure_dir_exists config_path + "/pipelines"
    ensure_dir_exists config_path + "/connectors"  
  end
  
  # Create a connector configuration file
  def connector
    name = params[:id]
    type = params[:type]
    unless name and type
      puts "Usage: rubysync connector connector_name -t connector_type"
      return
    end
    if base_path
      File.open("#{base_path}/connectors/#{name}_connector.rb", "w") do |file|
        file.puts connector_template(name, type)
      end
    else
      puts 'Change into a config dir and try again or create a config dir with "rubysync create"'
    end
  end

  # List the fields that the named connector can detect. This is
  # a good way to test if a connector config is functional.
  def fields
    connector_name = params[:id]
    connector = (connector_name)? ::RubySync::Connectors::BaseConnector.class_for(connector_name) : nil
    @field_names = connector && connector.fields || []
  end
  
  def pipeline
    name = params[:id]
    vault_name = params[:vault]
    client_name = params[:client]
    unless name
      puts "Usage: rubysync pipeline pipeline_name [-V vault] [-C client]"
      return
    end
    if base_path
      File.open("#{base_path}/pipelines/#{name}_pipeline.rb", "w") do |file|
        file.puts pipeline_template(name, vault_name, client_name)
      end
    else
      puts 'Change into a config dir and try again or create a config dir with "rubysync create"'
    end
    
  end
  
  
end


class View < SimpleConsole::View

  def default
    puts "Usage: rubysync command -p pipename"
    
    puts <<END
Valid commands are:

  create {name}           ; Create a rubysync configuration directory

  connector {name} -t {type} [--vault {name}] [--client {name}]
                          ; Create a connector of the given name in
                          ; the current rubysync configuration directory
                          
  fields {name}           ; list the fields detected by the named connector

  pipeline {name}         ; Create a rubysync pipeline of the given name
                          ; in the current rubysync configuration directory
                          
  once {name}             ; Execute the named pipeline within the current
                          ; configuration directory once and then exit
                          
  example                 ; Show an example of how this command might be used
END
end


def fields
  puts @field_names.join("\n")
end

def example
  puts <<END                          
  Example:
  
  This sets up the skeleton of a configuration for provisioning the your LDAP
  server from your HR system database.

  $ rubysync create my_ims
  $ cd my_ims
  $ rubysync connector corp_directory -t ldap
  $ rubysync connector hr_db -t active_record

  You would then edit the files:
  
    connectors/corp_directory_connector.rb  ; how to connect to corp ldap
    connectors/hr_db_connector.rb           ; how to connect to HR database

  $ rubysync pipeline hr_import -C hr_db -V corp_directory

  You would then edit the file "pipelines/hr_import_pipeline.rb" to configure the
  policy for synchronizing between the two connectors.
                                            
  You may then execute the pipeline in one-shot mode (daemon mode is coming):
  
  $ rubysync once hr_import
                                            
END
end
  
  def start
    puts "Not yet implemented"
  end

end


  def connector_template name, type
    type_class_name = "RubySync::Connectors::#{type.to_s.camelize}Connector"
    type_class = eval(type_class_name)
    sample_config = (type_class && type_class.respond_to?("sample_config")) ?
      type_class.sample_config : ""
    return <<-"end;"
class #{name.to_s.camelize}Connector < #{type_class_name}
  #{sample_config}
end
    end;
  end
  

  
  def pipeline_template name, vault_name, client_name
    vault = (vault_name)? ::RubySync::Connectors::BaseConnector.class_for(vault_name) : nil
    vault_fields = vault && vault.fields || %w{allow these fields through}
    possible_fields = (vault_fields.map {|n| ":#{n}"}).join(", ")

    client = (client_name)? ::RubySync::Connectors::BaseConnector.class_for(client_name) : nil
    client_fields = client && client.fields || []

    vault_specifier = (vault_name)? "vault :#{vault_name}" : "#vault :vault_connector_name"
    client_specifier = (client_name)? "client :#{client_name}" : "#client :client_connector_name"
    return <<-"end;"
class #{name.to_s.camelize}Pipeline < RubySync::Pipelines::BasePipeline

  #{client_specifier}

  #{vault_specifier}

  # Remove any fields that you don't want to set in the client from the vault
  allow_out #{possible_fields}

  # Remove any fields that you don't want to set in the vault from the client
  allow_in #{possible_fields}

  # If the client and vault have different names for the same field, define the
  # the mapping here. For example, if the vault has a field called "first name" and
  # the client has a field called givenName you may put:
  #    'first name' => 'givenName'
  # separate each mapping with a comma.
  # The following fields were detected on the client:
  # #{(client_fields.map {|f| "'#{f}'"}).join(", ")}
  map_vault_to_client {
    #{(vault_fields.map {|f| "#'#{f}' => 'a_client_field'"}).join(",\n\t\t")}
  }

  # in means going from client to vault
  #in_transform do
  #end

  # out means going from vault to client
  #out_transform do
  #end

end
    end;
  end


SimpleConsole::Application.run(ARGV, Controller, View)
